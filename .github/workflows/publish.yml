name: Publish

permissions:
  contents: read

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

env:
  CARGO_TERM_COLOR: always

jobs:
  verify_tag_matches_cargo:
    name: Verify tag equals Cargo.toml version (and is highest)
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    env:
      TAG_VERSION: ${{ github.ref_name }}
    outputs:
      should_publish: ${{ steps.match_check.outputs.should_publish }}
    steps:
      - name: Checkout tagged commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - id: match_check
        name: Validate Cargo.toml version equals tag and is highest
        run: |
          set -euo pipefail

          VERSION=${TAG_VERSION#v}
          # Extract version from Cargo.toml (root crate)
          CURRENT=$(sed -n 's/^version = "\([^"]*\)"/\1/p' Cargo.toml | head -1 || true)

          if [ -z "${CURRENT:-}" ]; then
            echo "Could not determine current version from Cargo.toml."
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Tag version:     $VERSION"
          echo "Cargo.toml:      $CURRENT"

          if [ "$CURRENT" != "$VERSION" ]; then
            echo "Tag version ($VERSION) does not match Cargo.toml version ($CURRENT)."
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Optional: ensure this tag is the highest semver among existing tags.
          git fetch --tags --force >/dev/null 2>&1 || true
          LAST_TAG=$(git tag -l 'v*' | sed 's/^v//' | sort -V | tail -n1 || true)
          if [ -n "$LAST_TAG" ]; then
            HIGHEST=$(printf "%s\n%s" "$LAST_TAG" "$VERSION" | sort -V | tail -n1)
            if [ "$HIGHEST" != "$VERSION" ]; then
              echo "Tag version ($VERSION) is not the highest known version (highest is $LAST_TAG)."
              echo "should_publish=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          echo "Tag matches Cargo.toml and is highest; proceeding."
          echo "should_publish=true" >> "$GITHUB_OUTPUT"

  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: verify_tag_matches_cargo
    if: needs.verify_tag_matches_cargo.outputs.should_publish == 'true'
    env:
      TAG_VERSION: ${{ github.ref_name }}
    steps:
      - name: Checkout tagged commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: clippy,rustfmt

      - name: Cache cargo registry and index
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: cargo-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            cargo-${{ runner.os }}-${{ runner.arch }}-

      - name: Preflight - fmt check
        run: cargo fmt --all --check

      - name: Preflight - clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Preflight - package manifest
        run: cargo package --list

      - name: Build release
        run: cargo build --release --verbose

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          PUBLISH_DRY_RUN: ${{ vars.PUBLISH_DRY_RUN }}
        run: |
          set -euo pipefail
          DRY_FLAG=""
          if [ "${PUBLISH_DRY_RUN:-}" = "true" ]; then
            DRY_FLAG="--dry-run"
            echo "Dry-run enabled; publishing will be simulated."
          fi
          cargo publish --token "$CARGO_REGISTRY_TOKEN" ${DRY_FLAG}
